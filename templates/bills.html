<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BillBot - Bills Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bills.css') }}">
</head>
<body>
    {% include 'sidebar.html' %}
    <main class="main-content ml-72 p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Bills Management</h1>
        <p class="text-gray-600 mb-8">View and track all your upcoming and past bill payments.</p>
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Upcoming Bills Summary</h2>
                <button id="toggleAdd" class="px-3 py-1 bg-[#38A169] text-white rounded">+ Add Bill</button>
            </div>

            <!-- Add Bill Modal -->
            <div id="addModal" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white rounded-lg w-11/12 md:w-2/3 lg:w-1/2 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Create New Bill</h3>
                        <button id="closeAdd" class="text-gray-500">✕</button>
                    </div>
                    <form id="addBillForm" class="space-y-4 mb-6" method="post" action="/bills/create">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input name="name" required class="w-full p-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea name="description" class="w-full p-2 border rounded" rows="2" placeholder="Optional description of the bill"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Amount</label>
                        <input name="amount" required type="number" step="0.01" class="w-full p-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tag</label>
                        <select name="tag" class="w-full p-2 border rounded">
                            <option value="">Select a category</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="groceries">Groceries</option>
                            <option value="rent">Rent</option>
                            <option value="electricity">Electricity</option>
                            <option value="water">Water</option>
                            <option value="gas">Gas</option>
                            <option value="internet">Internet</option>
                            <option value="phone">Phone</option>
                            <option value="insurance">Insurance</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="education">Education</option>
                            <option value="transportation">Transportation</option>
                            <option value="dining">Dining</option>
                            <option value="shopping">Shopping</option>
                            <option value="subscriptions">Subscriptions</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Payment Mode</label>
                        <select name="payment_mode" class="w-full p-2 border rounded">
                            <option value="">Select payment mode</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="debit_card">Debit Card</option>
                            <option value="upi">UPI</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="netbanking">Netbanking</option>
                            <option value="wallet">Wallet</option>
                            <option value="cash">Cash</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Period</label>
                        <select id="addPeriodSelect" name="period" class="w-full p-2 border rounded">
                            <option value="monthly">Monthly</option>
                            <option value="2-months">Every 2 months</option>
                            <option value="3-months">Every 3 months (Quarterly)</option>
                            <option value="6-months">Every 6 months</option>
                            <option value="yearly">Yearly</option>
                            <option value="one-time">One-time</option>
                        </select>
                        <input type="number" id="addIntervalCount" name="interval_count" value="1" min="1" class="mt-2 w-32 p-2 border rounded" title="Interval in months (for custom)" />
                        <p class="text-xs text-gray-500 mt-1">Choose a recurrence or set months manually above.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">First Payment Date</label>
                        <input name="first_payment_date" type="date" class="w-full p-2 border rounded" />
                        <p class="text-xs text-gray-500 mt-1">The date you first paid this bill. We'll calculate future due dates automatically.</p>
                    </div>
                </div>
                    <div class="flex justify-end">
                        <button type="submit" class="px-4 py-2 bg-[#38A169] text-white rounded">Create</button>
                    </div>
                    </form>
                </div>
            </div>

            <!-- Edit Bill Modal -->
            <div id="editModal" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white rounded-lg w-11/12 md:w-2/3 lg:w-1/2 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Edit Bill</h3>
                        <button id="closeEdit" class="text-gray-500">✕</button>
                    </div>
                    <form id="editBillForm" class="space-y-4 mb-6" method="post" action="">
                        <h4 class="font-semibold text-gray-800">Edit Bill</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input name="name" id="editName" required class="w-full p-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <input name="description" id="editDescription" class="w-full p-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Amount</label>
                        <input name="amount" id="editAmount" required type="number" step="0.01" class="w-full p-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tag</label>
                        <select name="tag" id="editTag" class="w-full p-2 border rounded">
                            <option value="">Select a category</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="groceries">Groceries</option>
                            <option value="rent">Rent</option>
                            <option value="electricity">Electricity</option>
                            <option value="water">Water</option>
                            <option value="gas">Gas</option>
                            <option value="internet">Internet</option>
                            <option value="phone">Phone</option>
                            <option value="insurance">Insurance</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="education">Education</option>
                            <option value="transportation">Transportation</option>
                            <option value="dining">Dining</option>
                            <option value="shopping">Shopping</option>
                            <option value="subscriptions">Subscriptions</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Payment Mode</label>
                            <select name="payment_mode" id="editPaymentMode" class="w-full p-2 border rounded">
                                <option value="">Select payment mode</option>
                                <option value="credit_card">Credit Card</option>
                                <option value="debit_card">Debit Card</option>
                                <option value="upi">UPI</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="netbanking">Netbanking</option>
                                <option value="wallet">Wallet</option>
                                <option value="cash">Cash</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Period</label>
                        <select name="period" id="editPeriod" class="w-full p-2 border rounded">
                            <option value="monthly">Monthly</option>
                            <option value="2-months">Every 2 months</option>
                            <option value="3-months">Every 3 months (Quarterly)</option>
                            <option value="6-months">Every 6 months</option>
                            <option value="yearly">Yearly</option>
                            <option value="one-time">One-time</option>
                        </select>
                        <input type="number" id="editIntervalCount" name="interval_count" value="1" min="1" class="mt-2 w-32 p-2 border rounded" title="Interval in months (for custom)" />
                        <p class="text-xs text-gray-500 mt-1">Choose a recurrence or set months manually above.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">First Payment Date</label>
                        <input name="first_payment_date" id="editFirstPaymentDate" type="date" class="w-full p-2 border rounded" />
                        <p class="text-xs text-gray-500 mt-1">The date you first paid this bill. We'll calculate future due dates automatically.</p>
                    </div>
                </div>
                        <div class="flex justify-end items-center space-x-3 mt-4">
                            <button type="button" id="cancelEdit" class="px-3 py-1 text-gray-700 bg-gray-100 border rounded hover:bg-gray-200 transition">Cancel</button>
                            <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Update</button>
                            <!-- Delete button (handled by JS to avoid nested form problems) -->
                            <button type="button" id="deleteBillBtn" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition">Delete</button>
                        </div>
                    </form>
                </div>
            </div>
                <ul class="space-y-3">
                {% for bill in bills %}
                <li class="bill-item relative flex justify-between p-4 border-b items-center bg-white rounded-lg shadow-sm cursor-pointer"
                    data-bill-id="{{ bill.id }}"
                    data-bill-name="{{ bill.name }}"
                    data-bill-description="{{ bill.description or '' }}"
                    data-bill-tag="{{ bill.tag or '' }}"
                    data-bill-payment-mode="{{ bill.payment_mode or '' }}"
                    data-bill-amount="{{ '%.2f' % (bill.amount_cents / 100) }}"
                    data-bill-period="{{ bill.period or '' }}"
                    data-bill-interval-count="{{ bill.interval_count or 1 }}"
                    data-bill-last-paid="{{ bill.last_paid.strftime('%Y-%m-%d') if bill.last_paid else '' }}">
                    <div class="flex-1">
                        <div class="font-medium text-lg">{{ bill.name }}</div>
                        <div class="text-sm text-gray-500">{{ bill.description or '' }}</div>
                        {% set tag_map = {
                            'entertainment':'bg-pink-600 text-white',
                            'groceries':'bg-emerald-600 text-white',
                            'rent':'bg-indigo-700 text-white',
                            'electricity':'bg-yellow-600 text-gray-900',
                            'water':'bg-sky-600 text-white',
                            'gas':'bg-orange-600 text-white',
                            'internet':'bg-violet-600 text-white',
                            'phone':'bg-rose-600 text-white',
                            'insurance':'bg-fuchsia-600 text-white',
                            'healthcare':'bg-red-600 text-white',
                            'education':'bg-emerald-700 text-white',
                            'transportation':'bg-cyan-600 text-gray-900',
                            'dining':'bg-amber-600 text-gray-900',
                            'shopping':'bg-stone-600 text-white',
                            'subscriptions':'bg-sky-700 text-white',
                            'other':'bg-gray-600 text-white',
                            'uncategorized':'bg-gray-600 text-white',
                        } %}
                        {% set tag_key = (bill.tag or 'Uncategorized')|lower %}
                        {% set tag_class = tag_map.get(tag_key, 'bg-gray-700 text-white') %}
                        {% set pm_map = {
                            'credit_card':'bg-blue-600 text-white',
                            'debit_card':'bg-sky-600 text-white',
                            'upi':'bg-emerald-600 text-white',
                            'bank_transfer':'bg-indigo-600 text-white',
                            'netbanking':'bg-violet-600 text-white',
                            'wallet':'bg-amber-500 text-gray-900',
                            'cash':'bg-lime-600 text-gray-900',
                            'other':'bg-gray-600 text-white',
                        } %}
                        {% set pm_key = (bill.payment_mode or '—')|lower %}
                        {% set pm_class = pm_map.get(pm_key, 'bg-gray-100 text-gray-800') %}
                        <div class="text-xs mt-2">
                            <span class="inline-block {{ tag_class }} px-2 py-1 rounded mr-2 font-semibold text-sm">{{ bill.tag or 'Uncategorized' }}</span>
                            <span class="inline-block {{ pm_class }} px-2 py-1 rounded mr-2 text-sm">{{ bill.payment_mode or '—' }}</span>
                            <span class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">{{ bill.period or '—' }}</span>
                        </div>
                    </div>
                    <div class="text-right flex items-center space-x-3">
                        <div>
                            <div class="text-red-500 font-bold text-xl">₹{{ '%.2f' % (bill.amount_cents / 100) }}</div>
                            <div class="text-sm text-gray-500">
                                {% if bill.next_due %}
                                    Due: {{ bill.next_due.strftime('%b %d, %Y') }}
                                {% else %}
                                    No due date
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </li>
                {% else %}
                <li class="p-4 text-gray-500 text-center bg-gray-50 rounded-lg">No bills yet. Add one using the + button above.</li>
                {% endfor %}
            </ul>
        </div>
    </main>
    <script>
        // Add modal controls
        const toggleAdd = document.getElementById('toggleAdd');
        const addModal = document.getElementById('addModal');
        const closeAdd = document.getElementById('closeAdd');
        toggleAdd.addEventListener('click', () => { addModal.classList.remove('hidden'); });
        closeAdd.addEventListener('click', () => { addModal.classList.add('hidden'); });
        addModal.addEventListener('click', (e) => { if (e.target === addModal) addModal.classList.add('hidden'); });

        // Intercept Add Bill form to submit via AJAX, prime overview cache and notify other tabs
        const addForm = document.getElementById('addBillForm');
        if (addForm) {
            addForm.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const btn = addForm.querySelector('button[type="submit"]');
                const orig = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = 'Creating...';
                try {
                    const fd = new FormData(addForm);
                    const resp = await fetch(addForm.action || '/bills/create', { method: 'POST', body: fd });
                    if (resp.ok) {
                        // Trigger background recompute so overview cache is refreshed asynchronously
                        try {
                            await fetch('/api/overview/trigger-refresh', { method: 'POST' });
                        } catch (err) {
                            console.warn('Could not trigger overview refresh', err);
                        }
                        // Notify other tabs (overview) to refresh via storage event
                        try { localStorage.setItem('billbot:refresh', Date.now()); } catch (e) { /* ignore */ }
                        // Close modal and reload bills list
                        addModal.classList.add('hidden');
                        window.location.href = '/bills';
                        return;
                    } else {
                        const text = await resp.text();
                        alert('Failed to create bill: ' + (text || resp.statusText));
                    }
                } catch (err) {
                    console.error('create failed', err);
                    alert('Create failed. See console.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = orig;
                }
            });
        }

        // Handle clicking a bill item (open centered edit/detail modal and populate)
        const editModal = document.getElementById('editModal');
        const closeEdit = document.getElementById('closeEdit');
        let _currentEditingBillId = null;
        document.querySelectorAll('.bill-item').forEach(li => {
            li.addEventListener('click', (e) => {
                // avoid opening modal if user clicked on a form control
                if (e.target.closest('button, a, form, input, select, textarea')) return;

                const billId = li.dataset.billId;
                const name = li.dataset.billName;
                const description = li.dataset.billDescription;
                const tag = li.dataset.billTag;
                const paymentMode = li.dataset.billPaymentMode;
                const amount = li.dataset.billAmount;
                const period = li.dataset.billPeriod;
                const lastPaid = li.dataset.billLastPaid;

                // Populate edit form inside modal
                document.getElementById('editName').value = name || '';
                document.getElementById('editDescription').value = description || '';
                document.getElementById('editAmount').value = amount || '';
                document.getElementById('editTag').value = tag || '';
                document.getElementById('editPaymentMode').value = paymentMode || '';
                document.getElementById('editPeriod').value = period || '';
                document.getElementById('editFirstPaymentDate').value = lastPaid || '';
                // populate interval count if present
                const intervalCount = li.dataset.billIntervalCount;
                const editIntervalInput = document.getElementById('editIntervalCount');
                if (editIntervalInput) editIntervalInput.value = intervalCount || 1;

                // Set form actions
                document.getElementById('editBillForm').action = `/bills/${billId}/edit`;
                _currentEditingBillId = billId;

                // Show edit modal and hide add modal
                editModal.classList.remove('hidden');
                addModal.classList.add('hidden');
            });
        });
        closeEdit.addEventListener('click', () => { editModal.classList.add('hidden'); });
        editModal.addEventListener('click', (e) => { if (e.target === editModal) editModal.classList.add('hidden'); });

        // Handle cancel edit - close the edit modal
        document.getElementById('cancelEdit').addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        // Delete via AJAX to avoid nested form issues and refresh overview after
        const deleteBtn = document.getElementById('deleteBillBtn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', async () => {
                if (!_currentEditingBillId) return;
                if (!confirm('Are you sure you want to delete this bill?')) return;
                try {
                    const resp = await fetch(`/bills/${_currentEditingBillId}/delete`, { method: 'POST' });
                    if (resp.ok) {
                        // close modal and reload bills list and refresh overview
                        editModal.classList.add('hidden');
                        // simple reload to show updated bills list
                        window.location.reload();
                    } else {
                        alert('Failed to delete bill.');
                    }
                } catch (err) {
                    console.error('delete failed', err);
                    alert('Delete failed. See console.');
                }
            });
        }
    </script>
</body>
</html>