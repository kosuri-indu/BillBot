<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BillBot - Overview Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/overview.css') }}">
</head>
<body>
    {% include 'sidebar.html' %}
    <main class="main-content ml-72 p-6 md:p-8 max-w-full">
        <header class="mb-6">
            <h1 class="text-3xl font-extrabold text-gray-900">Financial Overview</h1>
            <p class="text-gray-600 mt-1">Quick glance at your bills, categories and trends.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left: charts (spans 3 cols on large screens) -->
            <section class="lg:col-span-3 space-y-6">
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Monthly trend</h2>
                    <div class="min-h-[240px]"><canvas id="monthlySpendChart"></canvas></div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Cumulative spend</h2>
                    <div class="min-h-[180px]"><canvas id="cumulativeSpendChart"></canvas></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">By category</h3>
                        <div class="min-h-[200px]"><canvas id="tagBreakdownChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Payment modes</h3>
                        <div class="min-h-[200px]"><canvas id="paymentModeChart"></canvas></div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Recent creations</h3>
                    <div class="min-h-[160px]"><canvas id="createdHistoryChart"></canvas></div>
                </div>
            </section>

            <!-- Right: narration + metrics -->
            <aside class="space-y-4 lg:col-span-1 lg:col-start-4">
                <!-- make the insights sticky so it visually fills the right edge -->
                <div class="lg:sticky lg:top-6">
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="flex items-start justify-between">
                        <h3 class="text-lg font-semibold text-gray-800">Insights</h3>
                        <div>
                            <button id="refreshInsightsBtn" class="inline-flex items-center px-3 py-1.5 bg-sky-600 text-white text-sm rounded-md hover:bg-sky-700" title="Refresh insights">
                                <svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6"/></svg>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div id="narration" class="text-gray-700 text-sm mt-2">Loading insights…</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4 mt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Upcoming dues</h4>
                    <div id="upcomingTimeline" class="flex space-x-3 overflow-x-auto py-2">
                        <!-- timeline cards appended here -->
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="text-lg font-semibold text-gray-800">Metrics (recent month)</h3>
                    <div id="metricCards" class="mt-3 space-y-3">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-500">Total</div>
                            <div id="metricTotal" class="text-lg font-bold text-[#16A34A]">—</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-500">Avg bill</div>
                            <div id="metricAvg" class="text-lg font-bold">—</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-500">Bills created</div>
                            <div id="metricCount" class="text-lg font-bold">—</div>
                        </div>
                    </div>
                </div>
                </div>
            </aside>
        </div>

    </main>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    async function loadOverview(force = false) {
        const url = '/api/overview/data' + (force ? '?force=1' : '');
        const res = await fetch(url);
        const narrationEl = document.getElementById('narration');
        // reset narration area
        narrationEl.innerHTML = '';
        if (!res.ok) {
            narrationEl.textContent = 'Unable to load insights.';
            return;
        }

        const payload = await res.json();

        // narration (summary + bullets + top changes)
        const summary = payload && payload.narration && payload.narration.summary ? payload.narration.summary : 'No insights available.';
        const pSummary = document.createElement('p');
        pSummary.className = 'font-medium text-gray-800';
        pSummary.textContent = summary;
        narrationEl.appendChild(pSummary);

        if (payload && payload.narration && Array.isArray(payload.narration.bullets) && payload.narration.bullets.length) {
            const ul = document.createElement('ul');
            ul.className = 'mt-2 list-disc pl-5 text-sm text-gray-600';
            payload.narration.bullets.forEach(b => {
                const li = document.createElement('li');
                li.textContent = b;
                ul.appendChild(li);
            });
            narrationEl.appendChild(ul);
        }

        if (payload && payload.narration && Array.isArray(payload.narration.top_changes) && payload.narration.top_changes.length) {
            const tc = payload.narration.top_changes[0];
            const p = document.createElement('p');
            p.className = 'mt-3 text-sm text-gray-500';
            p.textContent = `Biggest month-over-month change: ${tc.month} (₹${tc.delta})`;
            narrationEl.appendChild(p);
        }

        // charts may be missing; be defensive
        const charts = payload && payload.charts ? payload.charts : null;
        const raw = charts && charts.raw ? charts.raw : (payload && payload.charts && payload.charts.raw ? payload.charts.raw : {});

        // metrics from raw aggregation
        try {
            const monthly = raw.monthly || {labels: [], data: [], counts: []};
            const lastIdx = monthly.data.length - 1;
            const totalLast = lastIdx >= 0 ? monthly.data[lastIdx] : 0;
            const countLast = lastIdx >= 0 ? monthly.counts[lastIdx] : 0;
            const avgLast = countLast > 0 ? (totalLast / countLast) : 0;
            document.getElementById('metricTotal').textContent = '₹' + totalLast.toFixed(2);
            document.getElementById('metricAvg').textContent = countLast > 0 ? '₹' + avgLast.toFixed(2) : '—';
            document.getElementById('metricCount').textContent = countLast;
        } catch (e) {
            console.warn('Could not compute metrics', e);
        }

        // draw charts safely
        try {
            if (charts && charts.monthly_spend) {
                const ctxM = document.getElementById('monthlySpendChart').getContext('2d');
                new Chart(ctxM, charts.monthly_spend);
            }
            if (charts && charts.cumulative_spend) {
                const ctxCum = document.getElementById('cumulativeSpendChart').getContext('2d');
                new Chart(ctxCum, charts.cumulative_spend);
            }
        } catch (e) { console.warn('monthly chart error', e); }

        try {
            if (charts && charts.tag_breakdown) {
                const ctxT = document.getElementById('tagBreakdownChart').getContext('2d');
                new Chart(ctxT, charts.tag_breakdown);
            }
        } catch (e) { console.warn('tag chart error', e); }

        try {
            if (charts && charts.payment_mode) {
                const ctxP = document.getElementById('paymentModeChart').getContext('2d');
                new Chart(ctxP, charts.payment_mode);
            }
        } catch (e) { console.warn('payment chart error', e); }

        try {
            const createdCfg = charts && charts.created_history ? charts.created_history : (raw && raw.created_history ? raw.created_history : null);
            if (createdCfg) {
                const ctxC = document.getElementById('createdHistoryChart').getContext('2d');
                new Chart(ctxC, createdCfg);
            }
        } catch (e) { console.warn('created chart error', e); }

        // upcoming dues timeline
        try {
            const timelineContainer = document.getElementById('upcomingTimeline');
            if (timelineContainer) {
                timelineContainer.innerHTML = '';
                const tl = charts && charts.upcoming_timeline ? charts.upcoming_timeline : (payload && payload.charts && payload.charts.upcoming_timeline ? payload.charts.upcoming_timeline : []);
                if (Array.isArray(tl) && tl.length) {
                    tl.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'min-w-[180px] bg-gray-50 border rounded p-3';
                        const name = document.createElement('div');
                        name.className = 'font-medium text-gray-800';
                        name.textContent = item.name || '—';
                        const date = document.createElement('div');
                        date.className = 'text-sm text-gray-500';
                        const d = new Date(item.due_date);
                        date.textContent = d.toLocaleDateString();
                        const amt = document.createElement('div');
                        amt.className = 'text-sm text-gray-700 mt-1 font-semibold';
                        amt.textContent = '₹' + (item.amount || 0).toFixed(2);
                        const meta = document.createElement('div');
                        meta.className = 'text-xs text-gray-500 mt-1';
                        meta.textContent = (item.tag || '') + (item.payment_mode ? (' • ' + item.payment_mode) : '');
                        card.appendChild(name);
                        card.appendChild(date);
                        card.appendChild(amt);
                        card.appendChild(meta);
                        timelineContainer.appendChild(card);
                    });
                } else {
                    timelineContainer.innerHTML = '<div class="text-sm text-gray-500">No upcoming dues</div>';
                }
            }
        } catch (e) { console.warn('timeline render error', e); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadOverview();
        const btn = document.getElementById('refreshInsightsBtn');
        if (btn) {
            btn.addEventListener('click', async () => {
                // show a simple busy state
                const orig = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3.5-3.5L12 0v4a8 8 0 100 16v-4l-3.5 3.5L12 24v-4a8 8 0 01-8-8z"></path></svg>Refreshing';
                try {
                    await loadOverview(true);
                } catch (e) {
                    console.warn('refresh failed', e);
                }
                btn.disabled = false;
                btn.innerHTML = orig;
            });
        }
    });

    // Listen for cross-tab notifications to refresh overview (set by bills page after create)
    window.addEventListener('storage', (e) => {
        if (!e) return;
        if (e.key === 'billbot:refresh') {
            try { loadOverview(true); } catch (err) { console.warn('refresh from storage failed', err); }
        }
    });

    // Also refresh when tab becomes visible again (helps when user switched back)
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            try { loadOverview(); } catch (err) { /* ignore */ }
        }
    });
</script>
</body>
</html>