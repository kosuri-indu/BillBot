<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BillBot - Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
</head>
<body>
    {% include 'sidebar.html' %}

    <main class="main-content">
        
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-900">My Profile</h1>
        </header>

        <div id="statusMessage" class="status-message" role="alert"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="card p-6 flex flex-col items-center">
                    <img src="https://via.placeholder.com/150" alt="User Avatar" class="w-32 h-32 rounded-full mb-4 border-4 border-[#38A169] object-cover">
                    <h2 class="text-2xl font-bold text-gray-900" id="profileName">User Name</h2>
                    <p class="text-gray-500 mb-6" id="profileEmail">user@example.com</p>
                    <button id="changePhotoBtn" class="px-6 py-2 brand-bg text-white font-medium rounded-lg brand-hover transition duration-150">
                        Change Photo
                    </button>
                </div>

                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Account Status</h3>
                    <div class="flex items-center justify-between p-3 bg-brand-light-green rounded-lg">
                        <span class="brand-green font-medium">Verified Account</span>
                        <svg class="w-6 h-6 brand-green" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">Last login: <span id="lastLogin">Today, 10:45 AM</span></p>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="card p-8">
                    <h3 class="text-xl font-extrabold text-gray-800 mb-6 border-b pb-3">Personal Information</h3>
                    <form id="profileForm" method="post" action="/update-profile" class="space-y-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="email" name="email" value="{{ session.get('user_email', '') }}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                        </div>

                        <div>
                            <label for="current_password" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                            <input type="password" id="current_password" name="current_password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                            <p class="text-xs text-gray-500 mt-1">Required to confirm changes</p>
                        </div>

                        <div>
                            <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">New Password (Optional)</label>
                            <input type="password" id="new_password" name="new_password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <p class="text-xs text-gray-500 mt-1">Leave blank to keep current password</p>
                        </div>

                        <div class="pt-4 flex justify-end">
                            <button type="submit" id="saveChangesBtn" class="px-8 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-extrabold text-gray-800 mb-6 border-b pb-3">Security & Actions</h3>
                    
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg mb-4">
                        <div>
                            <p class="font-medium text-gray-800">Change Password</p>
                            <p class="text-sm text-gray-500">Update your security credentials.</p>
                        </div>
                        <a href="/settings#password" class="brand-green font-medium hover:text-green-700 transition">Update</a>
                    </div>

                    <div class="p-4 border border-red-300 bg-red-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium text-red-800">Danger Zone: Delete Account</p>
                                <p class="text-sm text-red-600">Permanently remove your account and all associated data.</p>
                            </div>
                            <button id="deleteAccountBtn" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- DATA ---
        const countryList = [
            "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", 
            "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", 
            "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", 
            "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", 
            "Chile", "China", "Colombia", "Comoros", "Congo (Brazzaville)", "Congo (Kinshasa)", "Costa Rica", "Croatia", 
            "Cuba", "Cyprus", "Czechia", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", 
            "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", 
            "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", 
            "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", 
            "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", 
            "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", 
            "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", 
            "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", 
            "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", 
            "Norway", "Oman", "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", 
            "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", 
            "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", 
            "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", 
            "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", 
            "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", 
            "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", 
            "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
        ];
        
        // --- FUNCTIONS ---
        
        /**
         * Displays a temporary status message (success or error).
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error'.
         */
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';

            // Hide the message after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        /**
         * Handles the profile form submission.
         * @param {Event} e 
         */
        function handleProfileUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Simple validation check
            if (!data.first_name || !data.last_name || !data.country) {
                showStatus('Please fill in all required fields (First Name, Last Name, Country).', 'error');
                return;
            }
            
            console.log("Profile Data to Send:", data);
            
            // Simulate API call success
            showStatus('Profile updated successfully! ðŸŽ‰', 'success');

            document.getElementById('profileName').textContent = `${data.first_name} ${data.last_name}`;
            document.getElementById('saveChangesBtn').disabled = false;
        }

        /**
         * Handles the Delete Account action with a confirmation.
         */
        function handleDeleteAccount() {
            if (confirm("âš ï¸ WARNING: Are you absolutely sure you want to permanently delete your account? This action cannot be undone.")) {
                console.log("Account Deletion Initiated...");
                showStatus('Your account deletion request has been processed. Redirecting...', 'error');
                
                setTimeout(() => {
                    window.location.href = '/'; // Redirect to the auth/login page
                }, 3000); 
            }
        }

        /**
         * Populates the country dropdown.
         */
        function populateCountryDropdown() {
            const selectElement = document.getElementById('country');
            const defaultCountry = "United States"; // Set a default selection
            
            selectElement.innerHTML = '';
            
            let defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Select a Country";
            selectElement.appendChild(defaultOption);

            countryList.forEach(country => {
                let option = document.createElement('option');
                option.value = country;
                option.textContent = country;

                if (country === defaultCountry) {
                    option.selected = true;
                }

                selectElement.appendChild(option);
            });
        }

        // --- EVENT LISTENERS (Run on page load) ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Populate Country Dropdown
            populateCountryDropdown();

            // 2. Attach form submission handler
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);

            // 3. Attach Delete Account handler
            document.getElementById('deleteAccountBtn').addEventListener('click', handleDeleteAccount);

            // 4. Placeholder for Change Photo button
            document.getElementById('changePhotoBtn').addEventListener('click', () => {
                alert('File upload dialog would open here to change the profile picture.');
            });

            // 5. Update last login time dynamically
            document.getElementById('lastLogin').textContent = new Date().toLocaleString();
        });
    </script>
</body>
</html>